<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Zora Airdrop</title>
    <meta name="fc:frame" content="vNext" />
    <meta name="fc:frame:image" content="https://bafkreicokltvw5jigcmouiux6xfk4mdaah4tpbfwj3axn6vvfnf3qgfcbm.ipfs.nftstorage.link/" />
    <meta name="fc:frame:image:aspect_ratio" content="1:1" />
    <meta name="og:image" content="https://bafkreicokltvw5jigcmouiux6xfk4mdaah4tpbfwj3axn6vvfnf3qgfcbm.ipfs.nftstorage.link/" />
    
    <script src="https://unpkg.com/@farcaster/auth-kit@0.2.1"></script>
    <script src="https://unpkg.com/viem@2.7.12"></script>
    
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            background: #F7F7F7;
        }
        .container {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 {
            color: #8A63D2;
            margin-bottom: 20px;
        }
        .info {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
        }
        .button {
            background: #8A63D2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        .button:hover {
            background: #7250B7;
        }
        .button:disabled {
            background: #BBB;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .success {
            background: #e6f7e6;
            border: 1px solid #51a351;
            display: block;
        }
        .error {
            background: #f7e6e6;
            border: 1px solid #a35151;
            display: block;
        }
        .hidden {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8A63D2;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Zora Airdrop Claim</h1>
        
        <div>
            <p><strong>Wallet Address:</strong> <span id="walletAddress">0x6d711689E273a7C1962772381d8968bf37802Db8</span></p>
            <p><strong>Contract:</strong> 0x0000000002ba96C69b95E32CAAB8fc38bAB8B3F8</p>
            <p><strong>Network:</strong> Base</p>
        </div>
        
        <div class="info">
            <p id="infoText">正在检查Warpcast连接状态...</p>
        </div>
        
        <div id="connectContainer">
            <button id="connectButton" class="button">连接Warpcast</button>
        </div>
        
        <div id="claimContainer" class="hidden">
            <button id="claimButton" class="button">领取Zora空投</button>
        </div>
        
        <div id="statusContainer" class="status"></div>
        <div id="loader" class="loader"></div>
    </div>

    <script>
        const TARGET_ADDRESS = '0x6d711689E273a7C1962772381d8968bf37802Db8';
        const CONTRACT_ADDRESS = '0x0000000002ba96C69b95E32CAAB8fc38bAB8B3F8';
        const CALL_DATA = '0x1e83409a0000000000000000000000006d711689E273a7C1962772381d8968bf37802Db8';
        
        // 元素引用
        const walletAddressElem = document.getElementById('walletAddress');
        const infoTextElem = document.getElementById('infoText');
        const connectContainer = document.getElementById('connectContainer');
        const connectButton = document.getElementById('connectButton');
        const claimContainer = document.getElementById('claimContainer');
        const claimButton = document.getElementById('claimButton');
        const statusContainer = document.getElementById('statusContainer');
        const loader = document.getElementById('loader');
        
        // 检测是否在Warpcast内
        const isInWarpcast = !!window.ethereum && window.ethereum.isFarcaster;
        
        if (isInWarpcast) {
            infoTextElem.textContent = "检测到Warpcast环境，请点击连接钱包";
        } else {
            infoTextElem.textContent = "请在Warpcast应用内打开此页面";
            connectButton.disabled = true;
        }
        
        // 连接钱包
        connectButton.addEventListener('click', async () => {
            if (!isInWarpcast) {
                showStatus("请在Warpcast应用内打开此页面", "error");
                return;
            }
            
            try {
                loader.style.display = 'block';
                
                // 请求连接Warpcast钱包
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const userAddress = accounts[0];
                walletAddressElem.textContent = userAddress;
                
                // 检查链ID
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== '0x2105') { // Base链ID为8453 (0x2105)
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }]
                        });
                    } catch (error) {
                        showStatus("请确保您的Warpcast钱包已切换到Base网络", "error");
                        loader.style.display = 'none';
                        return;
                    }
                }
                
                // 检查用户钱包地址是否是目标地址
                if (userAddress.toLowerCase() !== TARGET_ADDRESS.toLowerCase()) {
                    showStatus(`警告: 当前连接的钱包地址 (${userAddress}) 与空投资格地址不匹配`, "error");
                } else {
                    connectContainer.classList.add('hidden');
                    claimContainer.classList.remove('hidden');
                    showStatus("钱包已连接，您可以领取空投", "success");
                }
                
                loader.style.display = 'none';
            } catch (error) {
                showStatus(`连接错误: ${error.message}`, "error");
                loader.style.display = 'none';
            }
        });
        
        // 领取空投
        claimButton.addEventListener('click', async () => {
            try {
                loader.style.display = 'block';
                claimButton.disabled = true;
                showStatus("正在发送交易...", "");
                
                // 构建交易参数
                const transactionParameters = {
                    to: CONTRACT_ADDRESS,
                    from: walletAddressElem.textContent,
                    data: CALL_DATA,
                    value: '0x0',
                    chainId: '0x2105' // Base网络
                };
                
                // 发送交易
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParameters]
                });
                
                showStatus(`交易已发送! 交易哈希: ${txHash}`, "success");
                
                // 监听交易状态
                checkTransactionStatus(txHash);
            } catch (error) {
                showStatus(`领取空投错误: ${error.message}`, "error");
                claimButton.disabled = false;
                loader.style.display = 'none';
            }
        });
        
        // 检查交易状态
        async function checkTransactionStatus(txHash) {
            try {
                const interval = setInterval(async () => {
                    const receipt = await window.ethereum.request({
                        method: 'eth_getTransactionReceipt',
                        params: [txHash]
                    });
                    
                    if (receipt) {
                        clearInterval(interval);
                        loader.style.display = 'none';
                        
                        if (receipt.status === '0x1') {
                            showStatus(`交易成功! Zora空投已成功领取。交易哈希: ${txHash}`, "success");
                        } else {
                            showStatus(`交易失败。交易哈希: ${txHash}`, "error");
                            claimButton.disabled = false;
                        }
                    }
                }, 2000);
            } catch (error) {
                console.error("检查交易状态错误:", error);
            }
        }
        
        // 显示状态信息
        function showStatus(message, type) {
            statusContainer.textContent = message;
            statusContainer.className = "status";
            
            if (type) {
                statusContainer.classList.add(type);
            }
        }
        
        // 检测是否自动连接
        window.addEventListener('load', async () => {
            if (isInWarpcast) {
                try {
                    // 尝试获取已连接的账户
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    
                    if (accounts && accounts.length > 0) {
                        // 已经连接了钱包
                        const userAddress = accounts[0];
                        walletAddressElem.textContent = userAddress;
                        
                        // 检查是否是目标地址
                        if (userAddress.toLowerCase() === TARGET_ADDRESS.toLowerCase()) {
                            connectContainer.classList.add('hidden');
                            claimContainer.classList.remove('hidden');
                            infoTextElem.textContent = "钱包已连接，可以直接领取空投";
                        } else {
                            infoTextElem.textContent = `当前连接的钱包地址与空投资格地址不匹配。请确保使用地址 ${TARGET_ADDRESS} 的钱包。`;
                        }
                    }
                } catch (error) {
                    console.error("自动连接检查错误:", error);
                }
            }
        });
    </script>
</body>
</html> 